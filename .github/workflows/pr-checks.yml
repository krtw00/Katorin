name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        run: |
          echo "base_branch=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          echo "head_branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Check branch naming
        run: |
          BRANCH="${{ steps.pr.outputs.head_branch }}"

          if [[ "$BRANCH" =~ ^(feature|fix|docs|refactor|test|chore)/.+ ]]; then
            echo "‚úÖ Branch naming is correct: $BRANCH"
          elif [[ "$BRANCH" =~ ^claude/.+ ]]; then
            echo "‚úÖ Claude Code branch detected: $BRANCH"
          else
            echo "‚ö†Ô∏è  Branch name does not follow convention: $BRANCH"
            echo "Expected format: feature/*, fix/*, docs/*, refactor/*, test/*, chore/*, or claude/*"
          fi

      - name: Get changed files
        id: changes
        run: |
          FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          echo "$FILES"
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for migration files
        run: |
          if echo "${{ steps.changes.outputs.files }}" | grep -q "supabase/migrations/"; then
            echo "‚ö†Ô∏è  Database migration files detected!"
            echo "Please ensure:"
            echo "- Migration files are tested locally"
            echo "- Migrations are reversible if possible"
            echo "- Database backup is available"
          else
            echo "No migration files changed"
          fi

      - name: Check for package.json changes
        run: |
          if echo "${{ steps.changes.outputs.files }}" | grep -q "package.json"; then
            echo "‚ö†Ô∏è  package.json was modified!"
            echo "Please ensure dependencies are necessary and reviewed"
          else
            echo "No package.json changes"
          fi

  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm ci --prefix frontend

      - name: Build and check size
        run: |
          npm run build --prefix frontend

          if [ -d "frontend/build" ]; then
            SIZE=$(du -sh frontend/build | cut -f1)
            echo "üì¶ Bundle size: $SIZE"

            # Check if build directory is larger than 5MB
            SIZE_MB=$(du -sm frontend/build | cut -f1)
            if [ "$SIZE_MB" -gt 5 ]; then
              echo "‚ö†Ô∏è  Bundle size is larger than 5MB. Consider code splitting or lazy loading."
            else
              echo "‚úÖ Bundle size is acceptable"
            fi
          fi
        env:
          CI: true
          REACT_APP_SUPABASE_URL: https://example.supabase.co
          REACT_APP_SUPABASE_ANON_KEY: dummy-key

  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm ci --prefix frontend

      - name: Run tests with coverage
        run: npm test -- --coverage --watchAll=false --passWithNoTests
        working-directory: frontend
        env:
          CI: true

      - name: Generate coverage summary
        if: always()
        run: |
          if [ -f "frontend/coverage/coverage-summary.json" ]; then
            echo "üìä Coverage Summary:"
            cat frontend/coverage/coverage-summary.json | grep -A 10 "total"
          else
            echo "‚ö†Ô∏è  No coverage data found. Tests may not have been executed."
          fi

      - name: Comment coverage on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coveragePath = 'frontend/coverage/coverage-summary.json';

            if (!fs.existsSync(coveragePath)) {
              console.log('No coverage file found');
              return;
            }

            const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
            const total = coverage.total;

            const comment = `## üìä Test Coverage Report

            | Metric | Coverage |
            |--------|----------|
            | Lines | ${total.lines.pct}% |
            | Statements | ${total.statements.pct}% |
            | Functions | ${total.functions.pct}% |
            | Branches | ${total.branches.pct}% |

            ${total.lines.pct < 30 ? '‚ö†Ô∏è Coverage is below 30%. Consider adding more tests.' : '‚úÖ Coverage looks good!'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        continue-on-error: true
