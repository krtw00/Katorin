# チーム・参加者機能の実装計画

## 背景

現在、Katorinには運営（管理者）による対戦管理機能がありますが、チームや参加者が自分でデータを入力・閲覧する機能が不足しています。この機能を実装することで、運営の負担を減らし、参加者の利便性を向上させます。

## システム構成

```
┌─────────────────────────────────────────────────────────┐
│ 運営（管理者）                                          │
│  - 大会作成                                             │
│  - ラウンド管理                                         │
│  - チーム管理（権限付与）                               │
│  - 全データの閲覧・編集                                 │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│ 大会                                                    │
│  - 大会名、スラッグ                                     │
│  - ラウンド（第1回戦、第2回戦...）                      │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│ チーム（参加者IDでログイン）                            │
│  - チーム名                                             │
│  - ユーザー名 + パスワード                              │
│  - 編集権限の有無 ← 運営が設定                          │
│                                                         │
│ 【チームができること】                                  │
│  ✓ メンバー（個人）の追加・削除                         │
│  ✓ 自チームの対戦リザルト入力（権限がある場合）         │
│  ✓ 全対戦のリザルト閲覧                                 │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│ 個人（参加者）                                          │
│  - 名前のみ管理（アカウントなし）                       │
│  - チームの配下に属する                                 │
│  - 編集権限フラグ（二重管理防止）                       │
│  - 個人戦績の表示（将来的に）                           │
└─────────────────────────────────────────────────────────┘
```

## 主要機能

### 1. 対戦リザルト入力の権限制御

#### 現在の問題
- 運営がすべての対戦結果を入力する必要がある
- チームが自分で結果を入力できない

#### 解決策
- **片側チームのみ**に入力権限を付与
  - 例: 「チームA vs チームB」の対戦で、チームAのみが入力可能
  - 右側（または左側）のチームに入力権限を設定
- これにより二重入力や矛盾を防止

#### 実装方法
```typescript
// matches テーブルに追加
interface Match {
  id: string;
  tournament_id: string;
  round_id: string;
  team_a: string;          // 左側チーム
  team_b: string;          // 右側チーム
  input_team_id: string;   // 🆕 入力権限を持つチームID（team_a or team_b）
  is_confirmed: boolean;   // 🆕 結果が確定済みか
  confirmed_at?: Date;     // 🆕 確定日時
  confirmed_by?: string;   // 🆕 確定したユーザーID
  // ... その他のフィールド
}
```

### 2. チーム編集権限

#### 目的
一部のチームには編集権限を与えず、閲覧のみ可能にする。

#### 使用例
- サブチーム（Bチーム）は編集不可、閲覧のみ
- 運営管理チームは全編集可能
- 通常のチームは自チームのみ編集可能

#### 実装
```typescript
interface Team {
  id: string;
  tournament_id: string;
  team_name: string;
  username: string;
  password_hash: string;
  can_edit: boolean;  // 🆕 編集権限の有無
}
```

### 3. 参加者（個人）の編集権限

#### 目的
同じチーム内で複数人が同時に編集すると矛盾が生じるのを防ぐ。

#### 実装
```typescript
interface Participant {
  id: string;
  team_id: string;
  name: string;
  can_edit: boolean;  // 🆕 この参加者が編集可能か
}
```

#### 運用例
- チームAに所属する「選手1」が `can_edit: true`
- チームAに所属する「選手2」が `can_edit: false`
- → 選手1のみがリザルト入力できる（選手2は閲覧のみ）

### 4. データエクスポート機能

#### 目的
対戦データをJSON/CSV形式でエクスポートし、Googleスプレッドシートなどで分析・共有できるようにする。

#### エクスポート形式

**JSON形式**
```json
{
  "tournament": {
    "name": "2025 Spring League",
    "slug": "2025-spring-league"
  },
  "rounds": [
    {
      "round_number": 1,
      "round_name": "予選プール",
      "matches": [
        {
          "team_a": "チームA",
          "team_b": "チームB",
          "score_a": 2,
          "score_b": 1,
          "date": "2025-10-29",
          "is_confirmed": true
        }
      ]
    }
  ]
}
```

**CSV形式**
```csv
ラウンド,ラウンド名,チームA,チームB,スコアA,スコアB,日付,確定済み
1,予選プール,チームA,チームB,2,1,2025-10-29,true
```

## 実装タスク

### Phase 1: MVP（Minimum Viable Product）

#### タスク 1.1: チームログイン機能の完成
- [x] チームログインフォームのUI実装（既存）
- [ ] チームログインAPIの実装
- [ ] JWT認証の実装（チーム用）
- [ ] ログイン後のリダイレクト処理

#### タスク 1.2: チーム専用ダッシュボード
- [ ] `/team-dashboard` ルートの追加
- [ ] 自チームの対戦一覧表示
- [ ] 次の対戦情報の表示
- [ ] 戦績サマリー（勝敗数、勝率）

#### タスク 1.3: 参加者管理（チーム側）
- [x] 参加者管理UIの基本実装（既存）
- [ ] チーム側での参加者追加機能
- [ ] チーム側での参加者削除機能
- [ ] 参加者の編集権限設定UI

### Phase 2: リザルト入力機能

#### タスク 2.1: データベーススキーマ拡張
- [ ] `matches` テーブルに `input_team_id` カラム追加
- [ ] `matches` テーブルに `is_confirmed` カラム追加
- [ ] `teams` テーブルに `can_edit` カラム追加
- [ ] マイグレーションファイル作成

#### タスク 2.2: リザルト入力API
- [ ] `POST /api/teams/:teamId/matches/:matchId/result` エンドポイント
- [ ] 入力権限チェック（`input_team_id` と一致するか）
- [ ] 編集権限チェック（チームの `can_edit` フラグ）
- [ ] リザルト確定処理

#### タスク 2.3: リザルト入力UI
- [ ] リザルト入力フォームコンポーネント
- [ ] 入力可能な対戦のみ表示
- [ ] 入力済み対戦の編集制限
- [ ] 確定ボタンの実装

### Phase 3: 権限管理強化

#### タスク 3.1: チーム権限管理（運営側）
- [ ] チーム編集ダイアログに `can_edit` フラグ追加
- [ ] `PUT /api/admin/teams/:teamId/permissions` エンドポイント
- [ ] 権限変更時の確認ダイアログ

#### タスク 3.2: 参加者権限管理
- [ ] 参加者編集ダイアログに `can_edit` フラグ追加
- [ ] 参加者の編集権限に基づくUI制御
- [ ] 二重入力防止メッセージ

### Phase 4: データエクスポート

#### タスク 4.1: エクスポートAPI
- [ ] `GET /api/tournaments/:tournamentId/export/json` エンドポイント
- [ ] `GET /api/tournaments/:tournamentId/export/csv` エンドポイント
- [ ] エクスポートデータの整形処理

#### タスク 4.2: エクスポートUI
- [ ] 運営画面にエクスポートボタン追加
- [ ] エクスポート形式の選択ダイアログ
- [ ] ダウンロード機能の実装

#### タスク 4.3: Googleスプレッドシート連携（オプション）
- [ ] Google Sheets API の調査
- [ ] OAuth認証の実装
- [ ] スプレッドシートへの書き込み機能

## セキュリティチェックリスト

- [ ] チームは自チームのデータのみアクセス可能
- [ ] 入力権限のないチームはリザルト入力不可
- [ ] JWT トークンの有効期限設定
- [ ] パスワードのハッシュ化（bcrypt）
- [ ] SQLインジェクション対策（パラメータ化クエリ）
- [ ] CSRF対策
- [ ] XSS対策（入力値のサニタイズ）

## テストケース

### チームログイン
- [ ] 正しいユーザー名とパスワードでログイン成功
- [ ] 間違ったパスワードでログイン失敗
- [ ] 存在しないユーザー名でログイン失敗
- [ ] トークンの有効期限切れでログアウト

### リザルト入力
- [ ] 入力権限のあるチームが正常に入力できる
- [ ] 入力権限のないチームが入力できない（403エラー）
- [ ] 編集権限のないチームが入力できない
- [ ] 確定済みのリザルトを編集できない

### 参加者管理
- [ ] チームが自チームの参加者を追加できる
- [ ] チームが他チームの参加者を追加できない
- [ ] 編集権限のある参加者のみ編集可能
- [ ] 編集権限のない参加者は閲覧のみ

## UI/UXガイドライン

### モバイル対応
- すべての画面をレスポンシブデザインにする
- タッチ操作を考慮したボタンサイズ（最小44px）
- スマートフォンでの入力を考慮したフォームデザイン

### 視覚的フィードバック
- 入力可能な対戦: 緑色のボーダー
- 入力済みの対戦: グレーアウト
- 確定済みの対戦: 青色のチェックマーク

### エラーメッセージ
- 権限エラー: 「この対戦の入力権限がありません」
- 編集権限エラー: 「編集権限がないため、リザルトを入力できません」
- 二重入力エラー: 「既に他のメンバーが入力中です」

## 未解決の質問

1. **個人戦績の表示**
   - Phase 1 に含めるか？
   - どのような形式で表示するか？（グラフ？表？）

2. **対戦の入力権限**
   - 右側と左側、どちらのチームに入力権限を付与するか？
   - 運営が柔軟に設定できるようにするか？

3. **対戦確定後の編集**
   - 確定後も運営は編集可能にするか？
   - チーム側で確定を取り消せるか？

4. **Googleスプレッドシート連携**
   - Phase 4 に含めるか、別イシューにするか？
   - Google Sheets API の利用コストは？

## 関連ドキュメント

- [開発ガイドライン](../development_guidelines.md)
- [コーディング規約](../coding_guidelines.md)
- [Gmail SMTP 設定ガイド](../gmail-smtp-setup.md)
- [README.md](../../README.md)

## 進捗管理

このイシューの進捗は以下のプロジェクトボードで管理します：

- [ ] Phase 1: MVP（Minimum Viable Product）
- [ ] Phase 2: リザルト入力機能
- [ ] Phase 3: 権限管理強化
- [ ] Phase 4: データエクスポート

## 次のステップ

1. このドキュメントをレビュー
2. 未解決の質問について決定
3. Phase 1 のタスクから着手
4. GitHubイシューとして登録

---

**作成日**: 2025-10-29
**最終更新**: 2025-10-29
**担当**: @krtw00
