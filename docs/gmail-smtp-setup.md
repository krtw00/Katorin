# Gmail を使ったパスワードリセットメール送信設定

このドキュメントでは、ドメインがなくても無料で使える Gmail SMTP を使ってパスワードリセットメール機能を設定する方法を説明します。

## 前提条件

- Gmail アカウント（既存のものでOK）
- Supabase プロジェクト（本番環境）

## 手順

### 1. Gmail でアプリパスワードを生成

Gmail の通常のパスワードではなく、アプリ専用のパスワードを生成する必要があります。

#### 1-1. Google アカウントの2段階認証を有効化

1. https://myaccount.google.com/security にアクセス
2. 「2段階認証プロセス」をクリック
3. 画面の指示に従って2段階認証を有効化（まだの場合）

#### 1-2. アプリパスワードを生成

1. https://myaccount.google.com/apppasswords にアクセス
2. 「アプリ パスワード」画面で以下を入力：
   - **アプリ名**: `Katorin` （任意の名前でOK）
3. 「作成」をクリック
4. **16桁のパスワード**が表示されるので、コピーして保存
   - 例: `abcd efgh ijkl mnop`（スペースは削除して使用）

⚠️ このパスワードは一度しか表示されないので、必ず保存してください。

### 2. Supabase プロジェクトで SMTP を設定

#### 2-1. Supabase ダッシュボードにログイン

1. https://supabase.com/dashboard にアクセス
2. 対象のプロジェクトを選択

#### 2-2. SMTP 設定を入力

1. 左メニューから **Project Settings** をクリック
2. **Authentication** → **SMTP Settings** を選択
3. 以下の情報を入力：

```
Enable Custom SMTP: ON （有効化）

SMTP Host: smtp.gmail.com
SMTP Port: 587
SMTP User: あなたのGmailアドレス（例: your-email@gmail.com）
SMTP Password: 先ほど生成した16桁のアプリパスワード（スペース無し）
Sender email: あなたのGmailアドレス（例: your-email@gmail.com）
Sender name: Katorin （任意の送信者名）
```

4. **Save** をクリック

### 3. メールテンプレートのカスタマイズ（任意）

パスワードリセットメールの文面をカスタマイズできます。

1. Supabase ダッシュボードで **Authentication** → **Email Templates** を選択
2. **Reset Password** を選択
3. メールの件名と本文を編集（デフォルトのままでもOK）

#### カスタマイズ例（日本語）

**件名**:
```
【Katorin】パスワードリセットのご案内
```

**本文**:
```html
<h2>パスワードリセット</h2>
<p>パスワードリセットのリクエストを受け付けました。</p>
<p>以下のリンクをクリックして、新しいパスワードを設定してください：</p>
<p><a href="{{ .ConfirmationURL }}">パスワードをリセット</a></p>
<p>このリンクは24時間有効です。</p>
<p>このメールに心当たりがない場合は、無視してください。</p>
```

### 4. リダイレクトURLの設定（重要）

パスワードリセット後のリダイレクト先を設定します。

#### 4-1. 環境変数の設定

バックエンド（API）の環境変数に以下を追加：

**開発環境** (`.env.local`):
```bash
PASSWORD_RESET_REDIRECT_URL=http://localhost:3000/password-reset
```

**本番環境**:
```bash
PASSWORD_RESET_REDIRECT_URL=https://your-app-domain.com/password-reset
```

⚠️ 本番環境では実際のドメインに置き換えてください。

#### 4-2. Supabase の URL Configuration

1. Supabase ダッシュボードで **Authentication** → **URL Configuration** を選択
2. **Redirect URLs** に以下を追加：
   - `http://localhost:3000/**` （開発環境用）
   - `https://your-app-domain.com/**` （本番環境用）

### 5. 動作確認

#### 5-1. テストユーザーを作成

1. Supabase Studio で **Authentication** → **Users** を開く
2. 「Add user」をクリック
3. 実際に受信できるメールアドレスとパスワードを入力
4. 「Create user」をクリック

#### 5-2. パスワードリセットをテスト

1. アプリケーションのログイン画面を開く
2. 「パスワードをお忘れですか？」をクリック
3. テストユーザーのメールアドレスを入力
4. 「リセットリンクを送信」をクリック
5. **Gmailの受信トレイを確認**
6. メール内のリンクをクリック
7. 新しいパスワードを設定

✅ メールが届き、パスワードリセットができれば成功です！

## Gmail の送信制限について

Gmail の無料アカウントには以下の制限があります：

- **1日あたり500通**まで
- **短時間に大量送信すると一時的にブロック**される可能性あり

### 制限を超える場合の対策

参加者が多い大会（500人以上）の場合は、以下を検討してください：

1. **複数のGmailアカウントを使用**
   - アカウントを分けて運用

2. **専用メールサービスに移行**
   - SendGrid（月12,000通無料）
   - Resend（月3,000通無料）
   - Amazon SES（非常に安価）

## トラブルシューティング

### メールが届かない場合

1. **迷惑メールフォルダを確認**
2. **Supabase のログを確認**
   - Dashboard → Logs → Auth Logs
3. **SMTP設定を再確認**
   - パスワードにスペースが入っていないか
   - メールアドレスが正しいか
4. **Gmail の「安全性の低いアプリ」設定**
   - 通常は不要ですが、古いGoogleアカウントの場合は設定が必要な場合があります

### エラー: "Invalid login credentials"

- アプリパスワードが間違っている可能性があります
- アプリパスワードを再生成して試してください

### メールの送信元が "via supabase.email" と表示される

- これは正常です
- 独自ドメインを使用したい場合は、ドメインを取得してDNS設定が必要です

## セキュリティに関する注意

- ✅ アプリパスワードは通常のパスワードより安全です
- ✅ アプリパスワードは個別に無効化できます
- ⚠️ アプリパスワードを環境変数ファイル（.env）に保存する場合、Gitにコミットしないでください
- ⚠️ 本番環境では環境変数を安全に管理してください（Vercel、Netlify等のシークレット管理機能を使用）

## まとめ

Gmail SMTP を使用することで、ドメインがなくても無料でパスワードリセットメール機能を実装できます。小規模〜中規模の大会運営には十分な機能です。

参加者が増えてきたら、専用のメールサービスへの移行を検討してください。
