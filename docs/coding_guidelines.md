# コーディング規約

## 1. はじめに
このドキュメントは、Katorinプロジェクトにおけるコーディング規約を定めます。一貫性のあるコードベースを維持し、可読性と保守性を高めることを目的とします。

## 2. 言語とフレームワーク
- **フロントエンド**: TypeScript, React 18, Material-UI (MUI)
- **バックエンド**: Supabase (Auth, Database, Storage, Edge Functions)
- **データベース**: PostgreSQL (Supabase)
- **ビルドツール**: Vite
- **国際化**: react-i18next
- **テスト**: Vitest, React Testing Library

## 3. 一般的な規約

### 3.1. インデント
- スペース2つを使用します。タブは使用しません。

### 3.2. ファイル名
- コンポーネントファイルは `PascalCase` を使用します (例: `LoginForm.tsx`)
- その他のファイルは `camelCase` または `kebab-case` を使用します (例: `useAuthorizedFetch.ts`, `auth-middleware.js`)

### 3.3. 変数名・関数名
- 変数名、関数名は `camelCase` を使用し、意味がわかるように命名します。
- 定数には `UPPER_SNAKE_CASE` を使用します。

### 3.4. コメント
- コードの意図や複雑なロジックを説明するためにコメントを使用します。
- JSDoc形式でのコメントを推奨します。

### 3.5. 型定義 (TypeScript)
- 明示的な型定義を積極的に使用します。
- `any` の使用は極力避け、やむを得ない場合は `unknown` を検討します。
- `unknown` を使用する場合は、型ガードで型を絞り込みます。
- インターフェース vs 型エイリアス:
  - オブジェクトの形状定義: `interface` を優先
  - Union型、Intersection型: `type` を使用
  - Propsや公開API: `interface` を使用 (拡張可能性のため)
- 型アサーション (`as`) は最小限に抑えます。

## 4. フロントエンド (React/TypeScript)

### 4.1. コンポーネント
- 関数コンポーネントとHooksを使用します。
- コンポーネントは単一責任の原則に従い、小さく再利用可能な単位で作成します。
- propsの型定義はインターフェースまたは型エイリアスで明示的に行います。

### 4.2. Hooks
- カスタムHooksを作成し、ロジックの再利用性を高めます。
- カスタムHooksは `use` プレフィックスで始めます (例: `useAuth`, `useLocalStorage`)。
- `useEffect` の依存配列は正しく設定し、ESLintの警告を無視しません。
- 無限ループを避けるため、依存配列には適切な値のみを含めます。

### 4.3. 状態管理
- ローカル状態: `useState`, `useReducer`
- グローバル状態: Context API または Zustand (検討中)
- サーバー状態: Supabase Realtime または React Query (検討中)

### 4.4. パフォーマンス最適化
- 不要な再レンダリングを避けるため、`React.memo`, `useMemo`, `useCallback` を適切に使用します。
- ただし、過度な最適化は避け、パフォーマンス問題が確認された場合に対応します。

## 5. バックエンド (Supabase)

### 5.1. Supabase Auth
- 認証はSupabase Authを使用します。
- セッション管理は `@supabase/auth-helpers-react` を活用します。
- パスワードリセット、メール認証などの機能を適切に実装します。

### 5.2. Edge Functions
- 複雑なビジネスロジックや外部API連携は、Supabase Edge Functions で実装します。
- Edge Functionsは Deno で記述します。
- エラーハンドリングを適切に行い、クライアントにわかりやすいエラーメッセージを返します。

## 6. データベース (Supabase)

### 6.1. スキーマ定義
- データベースのスキーマ変更は、必ずマイグレーションファイルを通じて行います。
- マイグレーションファイルは `supabase/migrations/` ディレクトリに配置します。
- マイグレーション作成: `npx supabase migration new <migration_name>`

### 6.2. Row Level Security (RLS)
- すべてのテーブルに RLS ポリシーを設定します。
- ポリシーは最小権限の原則に従い、必要最小限のアクセス権限を付与します。
- 例: ユーザーは自分のデータのみ読み書き可能

### 6.3. クエリ
- Supabaseクライアントを使用して、型安全なクエリを作成します。
- クエリビルダーを使用し、生のSQLは避けます (やむを得ない場合を除く)。
- エラーハンドリングを適切に行い、失敗時の処理を実装します。

### 6.4. リアルタイム機能
- リアルタイム更新が必要な場合は、Supabase Realtime を使用します。
- 不要なサブスクリプションは適切にクリーンアップします (`useEffect` のクリーンアップ関数を使用)。

## 7. 国際化 (i18n)

### 7.1. react-i18next の使用
- すべてのUIテキストは、react-i18next を使用して翻訳可能にします。
- 翻訳ファイルは `src/locales/` ディレクトリに配置します。
- サポート言語: 日本語 (ja), 英語 (en)

### 7.2. 翻訳キーの命名規則
- キーは階層構造で記述します (例: `auth.login.title`, `errors.network`)
- キー名は英語で、内容を表す明確な名前を使用します。
- キー名には `camelCase` を使用します。

### 7.3. ハードコーディングの禁止
- UIに表示するテキストは、直接コードに記述しません。
- 必ず翻訳キーを使用します。
- 例: `<Button>{t('common.submit')}</Button>`

### 7.4. 複数形・変数の対応
- 数値による複数形の切り替えは、i18next の機能を使用します。
- 動的な値は、変数として渡します (例: `t('greeting', { name: userName })`)

## 8. セキュリティ

### 8.1. 認証・認可
- 認証はSupabase Authを使用し、独自実装は避けます。
- 認証が必要なページは、認証ガードで保護します。
- 認証トークンは安全に保管します (Supabaseが自動管理)。

### 8.2. 環境変数・シークレット
- APIキー、パスワードなどは環境変数で管理します。
- `.env.local` ファイルはGit追跡対象外とします。
- フロントエンドに公開してよい環境変数のみ `VITE_` プレフィックスを付けます。
- サービスロールキーなどの機密情報は、フロントエンドで使用しません。

### 8.3. XSS対策
- ユーザー入力は常にエスケープします。
- `dangerouslySetInnerHTML` の使用は極力避けます。
- Reactのデフォルトのエスケープ機能を信頼します。

### 8.4. CSRF対策
- Supabase Authが提供するトークンベース認証を使用します。
- Cookie使用時は、SameSite属性を適切に設定します。

### 8.5. SQLインジェクション対策
- Supabaseクライアントのクエリビルダーを使用します。
- 生のSQLを使用する場合は、必ずパラメータ化します。

### 8.6. 依存関係の脆弱性管理
- `npm audit` を定期的に実行し、脆弱性をチェックします。
- 重大な脆弱性が見つかった場合は、速やかに対応します。

## 9. アクセシビリティ (a11y)

### 9.1. セマンティックHTML
- 意味のあるHTML要素を使用します (`<button>`, `<nav>`, `<main>` など)。
- `<div>` や `<span>` の多用を避けます。

### 9.2. ARIA属性
- 必要に応じてARIA属性を追加します (`aria-label`, `aria-describedby` など)。
- ただし、セマンティックHTMLで代替できる場合は、そちらを優先します。

### 9.3. キーボードナビゲーション
- すべてのインタラクティブ要素は、キーボードで操作可能にします。
- Tab キーでのフォーカス順序が論理的であることを確認します。
- フォーカス状態を視覚的に明確にします。

### 9.4. カラーコントラスト
- WCAG 2.1 AA基準を満たすコントラスト比を維持します。
- 色だけで情報を伝えないようにします (アイコンやテキストも併用)。

### 9.5. スクリーンリーダー対応
- 画像には適切な `alt` 属性を設定します。
- フォーム要素には `<label>` を関連付けます。
- エラーメッセージは、スクリーンリーダーで読み上げ可能にします。

## 10. コードフォーマット

### 10.1. ESLint
- ESLintの警告・エラーは、コミット前に修正します。
- 設定ファイル: `.eslintrc.cjs`

### 10.2. Prettier
- コードフォーマットは、Prettierで自動整形します。
- 設定ファイル: `.prettierrc`
- 保存時に自動フォーマットを推奨 (VSCode設定)

### 10.3. エディタ設定
- `.editorconfig` に従います。
- VSCode使用時は、推奨拡張機能をインストールします。
